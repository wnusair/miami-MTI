{% extends "base.html" %}

{% block title %}Permission Management{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="page-header">
        <h1 class="page-title">Permission Management</h1>
        <p class="page-subtitle">Configure what each role can see and do</p>
    </div>

    <div class="admin-nav">
        <a href="{{ url_for('admin.users') }}" class="btn btn-outline-dark">User Management</a>
        <a href="{{ url_for('admin.permissions') }}" class="btn btn-primary">Permissions</a>
    </div>

    <div class="permissions-grid">
        {% for role in roles %}
        <div class="card permission-card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="role-badge role-{{ role.name.lower() }}">{{ role.name }}</span>
                </h2>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.update_permissions', role_id=role.id) }}">
                    <div class="permission-section">
                        <h3 class="permission-section-title">Panel Visibility</h3>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_view_panel_1" 
                                {% if role.permissions and role.permissions.can_view_panel_1 %}checked{% endif %}>
                            <span class="checkbox-text">Panel 1: Live Sensor Feed</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_view_panel_2"
                                {% if role.permissions and role.permissions.can_view_panel_2 %}checked{% endif %}>
                            <span class="checkbox-text">Panel 2: Current Status / KPIs</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_view_panel_3"
                                {% if role.permissions and role.permissions.can_view_panel_3 %}checked{% endif %}>
                            <span class="checkbox-text">Panel 3: Historical Logs</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_view_panel_4"
                                {% if role.permissions and role.permissions.can_view_panel_4 %}checked{% endif %}>
                            <span class="checkbox-text">Panel 4: Device Health</span>
                        </label>
                    </div>

                    <div class="permission-section">
                        <h3 class="permission-section-title">Actions</h3>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_export_data"
                                {% if role.permissions and role.permissions.can_export_data %}checked{% endif %}>
                            <span class="checkbox-text">Export Data (.XLSX)</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_edit_data"
                                {% if role.permissions and role.permissions.can_edit_data %}checked{% endif %}>
                            <span class="checkbox-text">Edit / Write Data</span>
                        </label>
                    </div>

                    <div class="permission-section">
                        <h3 class="permission-section-title">Administration</h3>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_manage_users"
                                {% if role.permissions and role.permissions.can_manage_users %}checked{% endif %}
                                {% if role.name == 'Manager' %}onclick="return confirmManagerChange(this);"{% endif %}>
                            <span class="checkbox-text">Manage Users (Admin Access)</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_view_access_logs"
                                {% if role.permissions and role.permissions.can_view_access_logs %}checked{% endif %}>
                            <span class="checkbox-text">View Access Logs</span>
                        </label>
                    </div>

                    <div class="permission-actions">
                        <button type="submit" class="btn btn-primary">Save Permissions</button>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function confirmManagerChange(checkbox) {
    if (!checkbox.checked) {
        return confirm('Warning: Removing admin access from Manager role may lock you out. Are you sure?');
    }
    return true;
}
</script>
{% endblock %}
